<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实战技术预研 - rpc | 随心博客</title>
    <meta name="description" content="李岩">
    <link rel="icon" href="/meta.png">
    
    <link rel="preload" href="/assets/css/0.styles.6496ff17.css" as="style"><link rel="preload" href="/assets/js/app.5b8afd62.js" as="script"><link rel="preload" href="/assets/js/2.26f2bd2e.js" as="script"><link rel="preload" href="/assets/js/80.66a0b271.js" as="script"><link rel="prefetch" href="/assets/js/10.705d4443.js"><link rel="prefetch" href="/assets/js/100.d063b5b4.js"><link rel="prefetch" href="/assets/js/101.4582c35b.js"><link rel="prefetch" href="/assets/js/102.232e0dde.js"><link rel="prefetch" href="/assets/js/103.c8d25557.js"><link rel="prefetch" href="/assets/js/104.36ccd472.js"><link rel="prefetch" href="/assets/js/105.50bf76d7.js"><link rel="prefetch" href="/assets/js/106.5d2f8ad4.js"><link rel="prefetch" href="/assets/js/107.3fcec35f.js"><link rel="prefetch" href="/assets/js/108.4d2f14c2.js"><link rel="prefetch" href="/assets/js/109.b689b8f3.js"><link rel="prefetch" href="/assets/js/11.bdbd9766.js"><link rel="prefetch" href="/assets/js/110.3b54110b.js"><link rel="prefetch" href="/assets/js/111.7c57f5e1.js"><link rel="prefetch" href="/assets/js/112.ce99e9a0.js"><link rel="prefetch" href="/assets/js/113.f2ed2100.js"><link rel="prefetch" href="/assets/js/114.12ffa65c.js"><link rel="prefetch" href="/assets/js/115.2de143e5.js"><link rel="prefetch" href="/assets/js/116.f409b207.js"><link rel="prefetch" href="/assets/js/117.06bb8923.js"><link rel="prefetch" href="/assets/js/118.886bb150.js"><link rel="prefetch" href="/assets/js/119.18437523.js"><link rel="prefetch" href="/assets/js/12.359920d0.js"><link rel="prefetch" href="/assets/js/120.7c70b797.js"><link rel="prefetch" href="/assets/js/121.21138d68.js"><link rel="prefetch" href="/assets/js/122.d059d7c0.js"><link rel="prefetch" href="/assets/js/123.b5bd9d2b.js"><link rel="prefetch" href="/assets/js/124.49bccc4f.js"><link rel="prefetch" href="/assets/js/125.f6553933.js"><link rel="prefetch" href="/assets/js/126.6b104f67.js"><link rel="prefetch" href="/assets/js/127.e9ad96e9.js"><link rel="prefetch" href="/assets/js/128.392cd42f.js"><link rel="prefetch" href="/assets/js/129.65bb4b10.js"><link rel="prefetch" href="/assets/js/13.c251bb6d.js"><link rel="prefetch" href="/assets/js/130.9c00f55c.js"><link rel="prefetch" href="/assets/js/131.b89396ae.js"><link rel="prefetch" href="/assets/js/132.3664b8e1.js"><link rel="prefetch" href="/assets/js/133.9af49e12.js"><link rel="prefetch" href="/assets/js/134.5c9f222c.js"><link rel="prefetch" href="/assets/js/135.b7337869.js"><link rel="prefetch" href="/assets/js/136.8d465332.js"><link rel="prefetch" href="/assets/js/137.9bfa6405.js"><link rel="prefetch" href="/assets/js/138.3abb7d24.js"><link rel="prefetch" href="/assets/js/139.9b2bc9ca.js"><link rel="prefetch" href="/assets/js/14.6d6eacd3.js"><link rel="prefetch" href="/assets/js/140.3e4cf00c.js"><link rel="prefetch" href="/assets/js/141.4cb7870c.js"><link rel="prefetch" href="/assets/js/142.35045f36.js"><link rel="prefetch" href="/assets/js/143.ef8b52a4.js"><link rel="prefetch" href="/assets/js/144.5382b476.js"><link rel="prefetch" href="/assets/js/145.d1183138.js"><link rel="prefetch" href="/assets/js/146.18ed2627.js"><link rel="prefetch" href="/assets/js/147.8a109312.js"><link rel="prefetch" href="/assets/js/148.4ff80924.js"><link rel="prefetch" href="/assets/js/149.5458e40a.js"><link rel="prefetch" href="/assets/js/15.969df2fd.js"><link rel="prefetch" href="/assets/js/150.38e86593.js"><link rel="prefetch" href="/assets/js/151.e47f84f3.js"><link rel="prefetch" href="/assets/js/152.3daba2a5.js"><link rel="prefetch" href="/assets/js/153.2e69bf61.js"><link rel="prefetch" href="/assets/js/154.e83aa494.js"><link rel="prefetch" href="/assets/js/155.eff3fa36.js"><link rel="prefetch" href="/assets/js/156.68ba02a6.js"><link rel="prefetch" href="/assets/js/157.5fc0fd6c.js"><link rel="prefetch" href="/assets/js/158.a2f8643d.js"><link rel="prefetch" href="/assets/js/159.f061fc3b.js"><link rel="prefetch" href="/assets/js/16.93af31ac.js"><link rel="prefetch" href="/assets/js/160.922d9b61.js"><link rel="prefetch" href="/assets/js/161.10bafeb5.js"><link rel="prefetch" href="/assets/js/162.c8d2bff0.js"><link rel="prefetch" href="/assets/js/163.21fab3da.js"><link rel="prefetch" href="/assets/js/164.2f9a4c0a.js"><link rel="prefetch" href="/assets/js/165.a5c88488.js"><link rel="prefetch" href="/assets/js/166.df3a3395.js"><link rel="prefetch" href="/assets/js/167.a7b331c4.js"><link rel="prefetch" href="/assets/js/168.2ffced34.js"><link rel="prefetch" href="/assets/js/169.d9cbe4f3.js"><link rel="prefetch" href="/assets/js/17.4fe12c04.js"><link rel="prefetch" href="/assets/js/170.6d7ec79e.js"><link rel="prefetch" href="/assets/js/171.7c36dcde.js"><link rel="prefetch" href="/assets/js/172.c94761c8.js"><link rel="prefetch" href="/assets/js/173.52319acf.js"><link rel="prefetch" href="/assets/js/174.054ad281.js"><link rel="prefetch" href="/assets/js/175.f9e66221.js"><link rel="prefetch" href="/assets/js/176.5643433a.js"><link rel="prefetch" href="/assets/js/177.8030aa35.js"><link rel="prefetch" href="/assets/js/178.783841fc.js"><link rel="prefetch" href="/assets/js/179.31e092d5.js"><link rel="prefetch" href="/assets/js/18.8fde6dee.js"><link rel="prefetch" href="/assets/js/180.34d5c297.js"><link rel="prefetch" href="/assets/js/181.a836d6d7.js"><link rel="prefetch" href="/assets/js/182.0fb1942e.js"><link rel="prefetch" href="/assets/js/183.f786010e.js"><link rel="prefetch" href="/assets/js/184.b49e60aa.js"><link rel="prefetch" href="/assets/js/185.e9898f7c.js"><link rel="prefetch" href="/assets/js/186.6e4b6b88.js"><link rel="prefetch" href="/assets/js/187.ab3a7e16.js"><link rel="prefetch" href="/assets/js/188.77525743.js"><link rel="prefetch" href="/assets/js/189.df563c11.js"><link rel="prefetch" href="/assets/js/19.4eee66e8.js"><link rel="prefetch" href="/assets/js/190.60403d42.js"><link rel="prefetch" href="/assets/js/191.b1792b43.js"><link rel="prefetch" href="/assets/js/192.32a6cb54.js"><link rel="prefetch" href="/assets/js/193.3242cf83.js"><link rel="prefetch" href="/assets/js/194.655d1a6e.js"><link rel="prefetch" href="/assets/js/195.63e31ee2.js"><link rel="prefetch" href="/assets/js/196.7fa6aae5.js"><link rel="prefetch" href="/assets/js/197.a4b27ff7.js"><link rel="prefetch" href="/assets/js/198.d44c5a71.js"><link rel="prefetch" href="/assets/js/199.003a1723.js"><link rel="prefetch" href="/assets/js/20.ce08baab.js"><link rel="prefetch" href="/assets/js/200.543be16c.js"><link rel="prefetch" href="/assets/js/201.95f8066b.js"><link rel="prefetch" href="/assets/js/202.c9f68cca.js"><link rel="prefetch" href="/assets/js/203.89666bca.js"><link rel="prefetch" href="/assets/js/204.9c7264fe.js"><link rel="prefetch" href="/assets/js/205.9b111e8d.js"><link rel="prefetch" href="/assets/js/206.3e100a5d.js"><link rel="prefetch" href="/assets/js/207.181ad826.js"><link rel="prefetch" href="/assets/js/208.b9327be3.js"><link rel="prefetch" href="/assets/js/209.4deec58b.js"><link rel="prefetch" href="/assets/js/21.0b01c02a.js"><link rel="prefetch" href="/assets/js/210.aa5e4af7.js"><link rel="prefetch" href="/assets/js/211.f0ff0880.js"><link rel="prefetch" href="/assets/js/22.7a67a9a4.js"><link rel="prefetch" href="/assets/js/23.efb9856a.js"><link rel="prefetch" href="/assets/js/24.55302dbf.js"><link rel="prefetch" href="/assets/js/25.7061396b.js"><link rel="prefetch" href="/assets/js/26.c3845e4b.js"><link rel="prefetch" href="/assets/js/27.e0215617.js"><link rel="prefetch" href="/assets/js/28.5e671074.js"><link rel="prefetch" href="/assets/js/29.427adfaa.js"><link rel="prefetch" href="/assets/js/3.9cd2409c.js"><link rel="prefetch" href="/assets/js/30.e505a4f2.js"><link rel="prefetch" href="/assets/js/31.3d08e3fb.js"><link rel="prefetch" href="/assets/js/32.a28d0314.js"><link rel="prefetch" href="/assets/js/33.3e43944a.js"><link rel="prefetch" href="/assets/js/34.67243606.js"><link rel="prefetch" href="/assets/js/35.2df45cfb.js"><link rel="prefetch" href="/assets/js/36.e34a4764.js"><link rel="prefetch" href="/assets/js/37.ee1de8ec.js"><link rel="prefetch" href="/assets/js/38.7b8e81dd.js"><link rel="prefetch" href="/assets/js/39.3277fe3c.js"><link rel="prefetch" href="/assets/js/4.ec95372a.js"><link rel="prefetch" href="/assets/js/40.f7c77801.js"><link rel="prefetch" href="/assets/js/41.3647078b.js"><link rel="prefetch" href="/assets/js/42.57c713f6.js"><link rel="prefetch" href="/assets/js/43.1e4e1762.js"><link rel="prefetch" href="/assets/js/44.615425a7.js"><link rel="prefetch" href="/assets/js/45.4338d65b.js"><link rel="prefetch" href="/assets/js/46.34589809.js"><link rel="prefetch" href="/assets/js/47.d980cc22.js"><link rel="prefetch" href="/assets/js/48.615af50d.js"><link rel="prefetch" href="/assets/js/49.878ee0dc.js"><link rel="prefetch" href="/assets/js/5.e730c6e3.js"><link rel="prefetch" href="/assets/js/50.e687b809.js"><link rel="prefetch" href="/assets/js/51.80b24163.js"><link rel="prefetch" href="/assets/js/52.6fcab5f9.js"><link rel="prefetch" href="/assets/js/53.e98a99e4.js"><link rel="prefetch" href="/assets/js/54.f7ba75ee.js"><link rel="prefetch" href="/assets/js/55.b96dc8c0.js"><link rel="prefetch" href="/assets/js/56.30684913.js"><link rel="prefetch" href="/assets/js/57.2b10f070.js"><link rel="prefetch" href="/assets/js/58.dde78282.js"><link rel="prefetch" href="/assets/js/59.f2748667.js"><link rel="prefetch" href="/assets/js/6.4f4c8e1f.js"><link rel="prefetch" href="/assets/js/60.dee2d37e.js"><link rel="prefetch" href="/assets/js/61.5536e84b.js"><link rel="prefetch" href="/assets/js/62.926b1691.js"><link rel="prefetch" href="/assets/js/63.11468357.js"><link rel="prefetch" href="/assets/js/64.880781fa.js"><link rel="prefetch" href="/assets/js/65.13b9fbb9.js"><link rel="prefetch" href="/assets/js/66.13c0bc5d.js"><link rel="prefetch" href="/assets/js/67.37437fae.js"><link rel="prefetch" href="/assets/js/68.72d1cc98.js"><link rel="prefetch" href="/assets/js/69.abb5099c.js"><link rel="prefetch" href="/assets/js/7.29b3cfae.js"><link rel="prefetch" href="/assets/js/70.531c0939.js"><link rel="prefetch" href="/assets/js/71.47eb68af.js"><link rel="prefetch" href="/assets/js/72.d7436adb.js"><link rel="prefetch" href="/assets/js/73.7a1ab39d.js"><link rel="prefetch" href="/assets/js/74.0886c80e.js"><link rel="prefetch" href="/assets/js/75.8e981c11.js"><link rel="prefetch" href="/assets/js/76.257691fd.js"><link rel="prefetch" href="/assets/js/77.c1e3885c.js"><link rel="prefetch" href="/assets/js/78.8c8f4177.js"><link rel="prefetch" href="/assets/js/79.8119d41e.js"><link rel="prefetch" href="/assets/js/8.315d1a33.js"><link rel="prefetch" href="/assets/js/81.d6f3f6c3.js"><link rel="prefetch" href="/assets/js/82.681fa4d8.js"><link rel="prefetch" href="/assets/js/83.d3484106.js"><link rel="prefetch" href="/assets/js/84.a08cfc20.js"><link rel="prefetch" href="/assets/js/85.361f048b.js"><link rel="prefetch" href="/assets/js/86.3d658719.js"><link rel="prefetch" href="/assets/js/87.b00d7274.js"><link rel="prefetch" href="/assets/js/88.211ca64b.js"><link rel="prefetch" href="/assets/js/89.191e9fa3.js"><link rel="prefetch" href="/assets/js/9.20347705.js"><link rel="prefetch" href="/assets/js/90.f03b34b1.js"><link rel="prefetch" href="/assets/js/91.1b460aa9.js"><link rel="prefetch" href="/assets/js/92.344a79de.js"><link rel="prefetch" href="/assets/js/93.aa2e8b9e.js"><link rel="prefetch" href="/assets/js/94.cd3039b8.js"><link rel="prefetch" href="/assets/js/95.ef18c157.js"><link rel="prefetch" href="/assets/js/96.9ed8f30c.js"><link rel="prefetch" href="/assets/js/97.61a118ec.js"><link rel="prefetch" href="/assets/js/98.e276de0c.js"><link rel="prefetch" href="/assets/js/99.9e6e23b8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6496ff17.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">随心博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://github.com/strugglebook" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/construct/" class="nav-link">构建网站</a></div><div class="nav-item"><a href="/Flutter/" class="nav-link">Flutter</a></div><div class="nav-item"><a href="/Algorithm/" class="nav-link">算法世界</a></div><div class="nav-item"><a href="/MongDB/" class="nav-link">MongDB</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="小程序" class="dropdown-title"><span class="title">小程序</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/WeiXin/" class="nav-link">微信小程序入门和云开发</a></li><li class="dropdown-item"><!----> <a href="/WeiXin-Combat/" class="nav-link">微信小程序云开发实战</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="java" class="dropdown-title"><span class="title">java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Development-Tool/" class="nav-link">开发工具</a></li><li class="dropdown-item"><!----> <a href="/javaGrammar/" class="nav-link">java语法</a></li><li class="dropdown-item"><!----> <a href="/java-Database/" class="nav-link">java链接数据库</a></li><li class="dropdown-item"><!----> <a href="/javaWeb/" class="nav-link">javaWeb</a></li><li class="dropdown-item"><!----> <a href="/java-Frame/" class="nav-link">java搭建ssm框架</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具系列" class="dropdown-title"><span class="title">工具系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Jest/" class="nav-link">Jest</a></li><li class="dropdown-item"><!----> <a href="/Webpack/" class="nav-link">Webpack</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="全栈" class="dropdown-title"><span class="title">全栈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Full-Stack-FriendCircle/" class="nav-link">朋友圈</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="node" class="dropdown-title"><span class="title">node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">node入门</a></li><li class="dropdown-item"><!----> <a href="/node-RESTful/" class="nav-link">node与RESTful</a></li><li class="dropdown-item"><!----> <a href="/node-GraphQL/" class="nav-link">node与GraphQL</a></li><li class="dropdown-item"><!----> <a href="/node-BFF/" class="nav-link router-link-active">node与BFF</a></li><li class="dropdown-item"><!----> <a href="/node-blog/" class="nav-link">node博客后台</a></li><li class="dropdown-item"><!----> <a href="/node-weibo/" class="nav-link">node实战微博</a></li><li class="dropdown-item"><!----> <a href="/node-microService/" class="nav-link">node微服务</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="TS系列" class="dropdown-title"><span class="title">TS系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/typescript/" class="nav-link">TypeScript入门</a></li><li class="dropdown-item"><!----> <a href="/typescript-axios-font/" class="nav-link">TS重构axios前置学习</a></li><li class="dropdown-item"><!----> <a href="/typescript-axios/" class="nav-link">TS重构axios项目开发</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="react" class="dropdown-title"><span class="title">react</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react-jinjie/" class="nav-link">React实战进阶</a></li><li class="dropdown-item"><!----> <a href="/react-junior/" class="nav-link">React开发简书项目</a></li><li class="dropdown-item"><!----> <a href="/react-dazhong/" class="nav-link">React实战大众点评WebApp</a></li><li class="dropdown-item"><!----> <a href="/react-quna/" class="nav-link">React去哪儿网火车票PWA</a></li><li class="dropdown-item"><!----> <a href="/react-ssr/" class="nav-link">React服务器渲染原理解析</a></li><li class="dropdown-item"><!----> <a href="/react-next/" class="nav-link">React+Next.js+Koa2</a></li><li class="dropdown-item"><!----> <a href="/react-yuanma/" class="nav-link">React源码深度解析</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="vue" class="dropdown-title"><span class="title">vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue-shizhan/" class="nav-link">Vue开发实战</a></li><li class="dropdown-item"><!----> <a href="/vue-quna/" class="nav-link">Vue2.5开发去哪儿网App</a></li><li class="dropdown-item"><!----> <a href="/vue-shagncheng/" class="nav-link">Get全栈技能打造商城系统</a></li><li class="dropdown-item"><!----> <a href="/vue-dushu/" class="nav-link">Vue 实战商业级读书WebApp</a></li><li class="dropdown-item"><!----> <a href="/vue-ssr/" class="nav-link">Vue服务端渲染原理解析</a></li><li class="dropdown-item"><!----> <a href="/vue-nuxt/" class="nav-link">Vue全家桶+SSR+Koa2</a></li><li class="dropdown-item"><!----> <a href="/vue-yuanma/" class="nav-link">Vue.js源码全方位深入解析</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端系列" class="dropdown-title"><span class="title">前端系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Front-end/" class="nav-link">前端架构</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://github.com/strugglebook" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/construct/" class="nav-link">构建网站</a></div><div class="nav-item"><a href="/Flutter/" class="nav-link">Flutter</a></div><div class="nav-item"><a href="/Algorithm/" class="nav-link">算法世界</a></div><div class="nav-item"><a href="/MongDB/" class="nav-link">MongDB</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="小程序" class="dropdown-title"><span class="title">小程序</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/WeiXin/" class="nav-link">微信小程序入门和云开发</a></li><li class="dropdown-item"><!----> <a href="/WeiXin-Combat/" class="nav-link">微信小程序云开发实战</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="java" class="dropdown-title"><span class="title">java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Development-Tool/" class="nav-link">开发工具</a></li><li class="dropdown-item"><!----> <a href="/javaGrammar/" class="nav-link">java语法</a></li><li class="dropdown-item"><!----> <a href="/java-Database/" class="nav-link">java链接数据库</a></li><li class="dropdown-item"><!----> <a href="/javaWeb/" class="nav-link">javaWeb</a></li><li class="dropdown-item"><!----> <a href="/java-Frame/" class="nav-link">java搭建ssm框架</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具系列" class="dropdown-title"><span class="title">工具系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Jest/" class="nav-link">Jest</a></li><li class="dropdown-item"><!----> <a href="/Webpack/" class="nav-link">Webpack</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="全栈" class="dropdown-title"><span class="title">全栈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Full-Stack-FriendCircle/" class="nav-link">朋友圈</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="node" class="dropdown-title"><span class="title">node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">node入门</a></li><li class="dropdown-item"><!----> <a href="/node-RESTful/" class="nav-link">node与RESTful</a></li><li class="dropdown-item"><!----> <a href="/node-GraphQL/" class="nav-link">node与GraphQL</a></li><li class="dropdown-item"><!----> <a href="/node-BFF/" class="nav-link router-link-active">node与BFF</a></li><li class="dropdown-item"><!----> <a href="/node-blog/" class="nav-link">node博客后台</a></li><li class="dropdown-item"><!----> <a href="/node-weibo/" class="nav-link">node实战微博</a></li><li class="dropdown-item"><!----> <a href="/node-microService/" class="nav-link">node微服务</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="TS系列" class="dropdown-title"><span class="title">TS系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/typescript/" class="nav-link">TypeScript入门</a></li><li class="dropdown-item"><!----> <a href="/typescript-axios-font/" class="nav-link">TS重构axios前置学习</a></li><li class="dropdown-item"><!----> <a href="/typescript-axios/" class="nav-link">TS重构axios项目开发</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="react" class="dropdown-title"><span class="title">react</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react-jinjie/" class="nav-link">React实战进阶</a></li><li class="dropdown-item"><!----> <a href="/react-junior/" class="nav-link">React开发简书项目</a></li><li class="dropdown-item"><!----> <a href="/react-dazhong/" class="nav-link">React实战大众点评WebApp</a></li><li class="dropdown-item"><!----> <a href="/react-quna/" class="nav-link">React去哪儿网火车票PWA</a></li><li class="dropdown-item"><!----> <a href="/react-ssr/" class="nav-link">React服务器渲染原理解析</a></li><li class="dropdown-item"><!----> <a href="/react-next/" class="nav-link">React+Next.js+Koa2</a></li><li class="dropdown-item"><!----> <a href="/react-yuanma/" class="nav-link">React源码深度解析</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="vue" class="dropdown-title"><span class="title">vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue-shizhan/" class="nav-link">Vue开发实战</a></li><li class="dropdown-item"><!----> <a href="/vue-quna/" class="nav-link">Vue2.5开发去哪儿网App</a></li><li class="dropdown-item"><!----> <a href="/vue-shagncheng/" class="nav-link">Get全栈技能打造商城系统</a></li><li class="dropdown-item"><!----> <a href="/vue-dushu/" class="nav-link">Vue 实战商业级读书WebApp</a></li><li class="dropdown-item"><!----> <a href="/vue-ssr/" class="nav-link">Vue服务端渲染原理解析</a></li><li class="dropdown-item"><!----> <a href="/vue-nuxt/" class="nav-link">Vue全家桶+SSR+Koa2</a></li><li class="dropdown-item"><!----> <a href="/vue-yuanma/" class="nav-link">Vue.js源码全方位深入解析</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端系列" class="dropdown-title"><span class="title">前端系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Front-end/" class="nav-link">前端架构</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/node-BFF/" class="sidebar-link">node与BFF实战极客时间</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>技术预研</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-BFF/bff_one_yuyan_module.html" class="sidebar-link">实战技术预研 - 模块</a></li><li><a href="/node-BFF/bff_one_yuyan_async.html" class="sidebar-link">实战技术预研 - 异步</a></li><li><a href="/node-BFF/bff_one_yuyan_http.html" class="sidebar-link">实战技术预研 - http</a></li><li><a href="/node-BFF/bff_one_yuyan_rpc.html" class="active sidebar-link">实战技术预研 - rpc</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-BFF/bff_one_yuyan_rpc.html#rpc调用概述" class="sidebar-link">RPC调用概述</a></li><li class="sidebar-sub-header"><a href="/node-BFF/bff_one_yuyan_rpc.html#buffer编解码二进制数据包" class="sidebar-link">Buffer编解码二进制数据包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-BFF/bff_one_yuyan_rpc.html#_1-buffer的基本使用" class="sidebar-link">1. Buffer的基本使用</a></li><li class="sidebar-sub-header"><a href="/node-BFF/bff_one_yuyan_rpc.html#_2-编解码二进制数据包" class="sidebar-link">2. 编解码二进制数据包</a></li></ul></li><li class="sidebar-sub-header"><a href="/node-BFF/bff_one_yuyan_rpc.html#net模块搭建多路复用的rpc通道" class="sidebar-link">net模块搭建多路复用的RPC通道</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-BFF/bff_one_yuyan_rpc.html#_1-net模块的基本使用" class="sidebar-link">1. net模块的基本使用</a></li><li class="sidebar-sub-header"><a href="/node-BFF/bff_one_yuyan_rpc.html#_2-搭建多路复用的rpc通道" class="sidebar-link">2. 搭建多路复用的RPC通道</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实战演练</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能调优篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架和工程化篇</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="实战技术预研-rpc"><a href="#实战技术预研-rpc" class="header-anchor">#</a> 实战技术预研 - rpc</h1> <h2 id="rpc调用概述"><a href="#rpc调用概述" class="header-anchor">#</a> RPC调用概述</h2> <p><code>RPC</code>调用的全称叫做<font color="#DD1144">远程过程调用（Remote Procedure Call）</font></p> <p>这个东西实际上是后端技术之一，从前端的角度我们需要找一个类比的东西来帮助我们理解，这个东西就是<font color="#1E90FF">Ajax</font>。</p> <p><code>RPC</code>和<code>Ajax</code>之间两者相同点如下：</p> <ul><li><font color="#1E90FF">都是两个计算机之间的网络通信</font> <ul><li><code>Ajax</code>表示的是客户端和服务端之间的通信技术</li> <li><code>RPC</code>表示的服务端和服务端之间的通信技术</li></ul></li> <li><font color="#1E90FF">需要双方约定一个数据格式</font></li></ul> <p><code>RPC</code>和<code>Ajax</code>之间的不同点在于：</p> <ul><li><font color="#1E90FF">不一定使用DNS作为寻址服务</font> <ul><li><code>Ajax</code>一般访问域名要通过<code>DNS</code>来寻找真正访问服务的<code>IP</code></li> <li><code>RPC</code>一般是在内网中互相通信，所以使用<code>DNS</code>是划不来的，它会使用特有服务进行寻址</li></ul></li> <li><font color="#1E90FF">RPC一般不会使用HTTP协议，采用基于二进制的协议TCP或者UDP</font> <ul><li><code>Ajax</code>采用的<code>HTTP</code>协议是一种文本协议，要么是<code>html</code>要么是<code>json</code></li> <li>而<code>RPC</code>采用的二进制协议就是一个有很多位数的0和1的数据，比如<code>RPC [00100011000111]</code>, <font color="#DD1144">所以二进制协议有更小的数据包的体积和更快的编码速率</font>，因为计算机存储资源就是二进制。</li></ul></li></ul> <p>当<code>RPC</code>采用<code>TCP</code>通信的时候，方式也有如下三种</p> <ul><li><font color="#DD1144">单工通信</font>：在<code>TCP</code>链接的过程中永远只能有一方给另外一方发送数据</li> <li><font color="#DD1144">半双工通信</font>：在同一时间内，只能由一方给另外一方发送数据，可以理解为轮番单工通信</li> <li><font color="#DD1144">全双工通信</font>：在同一时间内，双方都能向对方发送数据
<img src="/node_rpctongixn.png" alt="PRC三种调用方式"></li></ul> <h2 id="buffer编解码二进制数据包"><a href="#buffer编解码二进制数据包" class="header-anchor">#</a> Buffer编解码二进制数据包</h2> <h3 id="_1-buffer的基本使用"><a href="#_1-buffer的基本使用" class="header-anchor">#</a> 1. Buffer的基本使用</h3> <p><font color="#1E90FF"><strong>① Buffer的创建</strong></font></p> <p>在此之前我们需要去简单的学习依一下<code>Buffer</code>的两个<code>API</code></p> <ul><li><font color="#1E90FF">Buffer.from()</font>: 根据现有的数据结构去创建<code>buffer</code>数据</li> <li><font color="#1E90FF">Buffer.alloc()</font>: 指定<code>buffer</code>数据的长度来创建<code>buffer</code>数据</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> buffer1 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'geekbang'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> buffer2 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> buffer3 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer1<span class="token punctuation">)</span> <span class="token comment">// &lt;Buffer 67 65 65 6b 62 61 6e 67&gt;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer2<span class="token punctuation">)</span> <span class="token comment">// &lt;Buffer 01 02 03 04&gt;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer3<span class="token punctuation">)</span> <span class="token comment">// &lt;Buffer 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00&gt;</span>
</code></pre></div><p><font color="#1E90FF"><strong>② Buffer的读写</strong></font></p> <p>关于<code>Buffer</code>的数据读取在官网上有很多方法：如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>buf<span class="token punctuation">.</span><span class="token function">readBigInt64BE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readBigInt64LE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readBigUInt64BE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readBigUInt64LE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readDoubleBE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readDoubleLE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readFloatBE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readFloatLE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readInt8</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readInt16BE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readInt16LE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readInt32BE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readInt32LE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readIntBE</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> byteLength<span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readIntLE</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> byteLength<span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readUInt8</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readUInt16BE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readUInt16LE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readUInt32BE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readUInt32LE</span><span class="token punctuation">(</span><span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readUIntBE</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> byteLength<span class="token punctuation">)</span>
buf<span class="token punctuation">.</span><span class="token function">readUIntLE</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> byteLength<span class="token punctuation">)</span>
</code></pre></div><p>细心的同学会发现这些方法名称有<code>BE</code>和<code>LE</code>的区别，这个大段和小段的意思，说白了就是方向的问题，而<code>Int8</code>是没有<code>BE</code>和<code>LE</code>的区别的，我们用代码来演示一下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>buffer2<span class="token punctuation">.</span><span class="token function">writeInt8</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 在buffer2的第二位写入一个int8 的数字12</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer2<span class="token punctuation">)</span> <span class="token comment">// &lt;Buffer 01 0c 03 04&gt;</span>

buffer2<span class="token punctuation">.</span><span class="token function">writeInt16BE</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 在buffer2的第三位开始写一个 int16的数字 512</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer2<span class="token punctuation">)</span> <span class="token comment">// &lt;Buffer 01 0c 02 00&gt;</span>

buffer2<span class="token punctuation">.</span><span class="token function">writeInt16LE</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 在buffer2的第三位开始写一个 int16的数字 512</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer2<span class="token punctuation">)</span> <span class="token comment">// &lt;Buffer 01 0c 00 02&gt;</span>
</code></pre></div><p>所以你看到了，因为<code>int8</code>类型的数字只占一位，所以不存在方向不方向的问题，而<code>int16</code>类型的数字要占两位，比如512用16进制表示就是 [02 00],所以使用<code>BE</code>表示正方向，而<code>LE</code>表示反方向。具体使用什么样的表示方法要和被人协商议定。</p> <h3 id="_2-编解码二进制数据包"><a href="#_2-编解码二进制数据包" class="header-anchor">#</a> 2. 编解码二进制数据包</h3> <p>之前我们在讲<code>json</code>是<code>http</code>文本协议的一种格式，而二进制是<code>TCP</code>二进制协议的格式，我们现在要将<code>{ id: 1, name: 'taopoppy', school: '电子科技大学'}</code> 这样一个<code>JS</code>对象通过两种协议发送，过程如下:</p> <img src="/node_tcp_rpc_buffer_encode_decode.png" alt="数据传输过程"> <p>所以你就知道了：<font color="#DD1144">二进制协议中的不同的字段实际是塞在一个二进制数据包中的不同位置而已</font>，比如上述的</p> <ul><li><code>id: 1</code>对应的二进制的一段位置就是<code>08 01</code></li> <li><code>name: 'taopoppy'</code>对应的二进制的一段位置就是<code>12 08 74 61 6f 70 6f 70 70 79</code></li> <li><code>school: '电子科技大学'</code>对应的二进制的一段位置就是<code>1a 12 e7 94 b5 e5 ad 90 e7 a7 91 e6 8a 80 e5 a4 a7 e5 ad a6</code></li></ul> <p>在走<code>http</code>路线的时候我们可以通过<code>JSON.stringify</code>和<code>JSON.parse</code>两个方法实现对文本数据的编码和解码，在<code>TCP</code>路线当中我们可以借用第三方包的方法来实现编码和解码,第三方包的使用方法我们可以参考<a href="https://www.npmjs.com/package/protocol-buffers" target="_blank" rel="noopener noreferrer">官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// test.proto</span>
message Student <span class="token punctuation">{</span>
  required int32 id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  required string name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  required string school <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index</span>
<span class="token keyword">const</span> protobuf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'protocol-buffers'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> schame <span class="token operator">=</span> <span class="token function">protobuf</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/test.proto'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> buf <span class="token operator">=</span> schame<span class="token punctuation">.</span>Student<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  name<span class="token punctuation">:</span> <span class="token string">'taopoppy'</span><span class="token punctuation">,</span>
  school<span class="token punctuation">:</span> <span class="token string">'电子科技大学'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token comment">// &lt;Buffer 08 01 12 08 74 61 6f 70 6f 70 70 79 1a 12 e7 94 b5 e5 ad 90 e7 a7 91 e6 8a 80 e5 a4 a7 e5 ad a6&gt;</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> schame<span class="token punctuation">.</span>Student<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment">// { id: 1, name: 'taopoppy', school: '电子科技大学' }</span>

</code></pre></div><h2 id="net模块搭建多路复用的rpc通道"><a href="#net模块搭建多路复用的rpc通道" class="header-anchor">#</a> net模块搭建多路复用的RPC通道</h2> <h3 id="_1-net模块的基本使用"><a href="#_1-net模块的基本使用" class="header-anchor">#</a> 1. net模块的基本使用</h3> <p><font color="#1E90FF"><strong>① 单工通信</strong></font></p> <p><code>node</code>当中的<code>net</code>模块和<code>http</code>模块非常的相似，既然是<code>RPC</code>通道，就会有两个头，一个是请求发送的一方，一个是请求接收的一方，我们简称<code>client</code>和<code>server</code>:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// client.js</span>
<span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">net<span class="token punctuation">.</span>Socket</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host<span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
  port<span class="token punctuation">:</span> <span class="token string">'4000'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'good morning geekbang'</span><span class="token punctuation">)</span>
</code></pre></div><p>然后我们先启动服务端的程序，然后再启动客户端的程序，就实现了一个最简单的<font color="#3eaf7c">单工通信</font>，上面两个代码要注意的就是：<code>socket</code>在计算机网络编程里面代表的是：<font color="#DD1144">网络通路的写入和取出的代理对象</font></p> <p><font color="#1E90FF"><strong>② 半双工通信</strong></font></p> <p>前面我们实现了一个简单的单工通信的案例，现在我们需要写一个正儿八经的数据请求和返回的半双工通信</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 拿到buffer数据并读取出来</span>
    <span class="token keyword">const</span> lessonid <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">readInt32BE</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>lessonid<span class="token punctuation">)</span>
    <span class="token comment">// 然后把对应的数据取出来包装成为buffer返回</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>
        Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>lessonid<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">136797</span><span class="token punctuation">:</span> <span class="token string">&quot;01 | 课程介绍&quot;</span><span class="token punctuation">,</span><span class="token number">136798</span><span class="token punctuation">:</span> <span class="token string">&quot;02 | 内容综述&quot;</span><span class="token punctuation">,</span><span class="token number">136799</span><span class="token punctuation">:</span> <span class="token string">&quot;03 | Node.js是什么？&quot;</span><span class="token punctuation">,</span><span class="token number">136800</span><span class="token punctuation">:</span> <span class="token string">&quot;04 | Node.js可以用来做什么？&quot;</span><span class="token punctuation">,</span><span class="token number">136801</span><span class="token punctuation">:</span> <span class="token string">&quot;05 | 课程实战项目介绍&quot;</span><span class="token punctuation">,</span>
  <span class="token number">136803</span><span class="token punctuation">:</span> <span class="token string">&quot;06 | 什么是技术预研？&quot;</span><span class="token punctuation">,</span><span class="token number">136804</span><span class="token punctuation">:</span> <span class="token string">&quot;07 | Node.js开发环境安装&quot;</span><span class="token punctuation">,</span><span class="token number">136806</span><span class="token punctuation">:</span> <span class="token string">&quot;08 | 第一个Node.js程序：石头剪刀布游戏&quot;</span><span class="token punctuation">,</span><span class="token number">136807</span><span class="token punctuation">:</span> <span class="token string">&quot;09 | 模块：CommonJS规范&quot;</span><span class="token punctuation">,</span>
  <span class="token number">136808</span><span class="token punctuation">:</span> <span class="token string">&quot;10 | 模块：使用模块规范改造石头剪刀布游戏&quot;</span><span class="token punctuation">,</span><span class="token number">136809</span><span class="token punctuation">:</span> <span class="token string">&quot;11 | 模块：npm&quot;</span><span class="token punctuation">,</span><span class="token number">141994</span><span class="token punctuation">:</span> <span class="token string">&quot;12 | 模块：Node.js内置模块&quot;</span><span class="token punctuation">,</span><span class="token number">143517</span><span class="token punctuation">:</span> <span class="token string">&quot;13 | 异步：非阻塞I/O&quot;</span><span class="token punctuation">,</span>
  <span class="token number">143557</span><span class="token punctuation">:</span> <span class="token string">&quot;14 | 异步：异步编程之callback&quot;</span><span class="token punctuation">,</span><span class="token number">143564</span><span class="token punctuation">:</span> <span class="token string">&quot;15 | 异步：事件循环&quot;</span><span class="token punctuation">,</span><span class="token number">143644</span><span class="token punctuation">:</span> <span class="token string">&quot;16 | 异步：异步编程之Promise&quot;</span><span class="token punctuation">,</span><span class="token number">146470</span><span class="token punctuation">:</span> <span class="token string">&quot;17 | 异步：异步编程之async/await&quot;</span><span class="token punctuation">,</span>
  <span class="token number">146569</span><span class="token punctuation">:</span> <span class="token string">&quot;18 | HTTP：什么是HTTP服务器？&quot;</span><span class="token punctuation">,</span><span class="token number">146582</span><span class="token punctuation">:</span> <span class="token string">&quot;19 | HTTP：简单实现一个HTTP服务器&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// client.js</span>
<span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">net<span class="token punctuation">.</span>Socket</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host<span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
  port<span class="token punctuation">:</span> <span class="token string">'4000'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> lessonids <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;136797&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136798&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136799&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136800&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136801&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136803&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136804&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136806&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136807&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136808&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;136809&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;141994&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;143517&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;143557&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;143564&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;143644&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;146470&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;146569&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;146582&quot;</span>
<span class="token punctuation">]</span>

<span class="token keyword">let</span> id <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> lessonids<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>

socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 接收到返回数据打印出来</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 再随机发送一个数据</span>
  id <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> lessonids<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
  buffer<span class="token punctuation">.</span><span class="token function">writeInt32BE</span><span class="token punctuation">(</span>
    lessonids<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">return</span> buffer
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-搭建多路复用的rpc通道"><a href="#_2-搭建多路复用的rpc通道" class="header-anchor">#</a> 2. 搭建多路复用的RPC通道</h3> <p><font color="#DD1144">多路复用就是在一个通信通路（tcp连接）上多次进行通信，减少建立连接的消耗。所以最好要求通信通路支持全双工通信</font>。那我们接下来要介绍的就是全双工通信，那么在半双工通信的基础上我们要想两个问题：</p> <ul><li>假如同时有很多数据发送到服务端，服务端返回的顺序和发送的顺序不一样，我们需要给数据库包添加序列号</li> <li><code>TCP</code>底层存在黏包现象，我们需要在服务端去处理这个问题</li></ul> <p><font color="#1E90FF"><strong>① 全双工通信 - 包序列号</strong></font></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 拿到buffer数据并读取出来</span>
    <span class="token keyword">const</span> seqBuffer <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> lessonid <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">readInt32BE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>lessonid<span class="token punctuation">)</span>
    <span class="token comment">// 然后把对应的数据取出来包装成为buffer返回</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> returnBuffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        seqBuffer<span class="token punctuation">,</span>
        Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>lessonid<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
      socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>
        returnBuffer
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">136797</span><span class="token punctuation">:</span> <span class="token string">&quot;01 | 课程介绍&quot;</span><span class="token punctuation">,</span><span class="token number">136798</span><span class="token punctuation">:</span> <span class="token string">&quot;02 | 内容综述&quot;</span><span class="token punctuation">,</span><span class="token number">136799</span><span class="token punctuation">:</span> <span class="token string">&quot;03 | Node.js是什么？&quot;</span><span class="token punctuation">,</span><span class="token number">136800</span><span class="token punctuation">:</span> <span class="token string">&quot;04 | Node.js可以用来做什么？&quot;</span><span class="token punctuation">,</span><span class="token number">136801</span><span class="token punctuation">:</span> <span class="token string">&quot;05 | 课程实战项目介绍&quot;</span><span class="token punctuation">,</span>
  <span class="token number">136803</span><span class="token punctuation">:</span> <span class="token string">&quot;06 | 什么是技术预研？&quot;</span><span class="token punctuation">,</span><span class="token number">136804</span><span class="token punctuation">:</span> <span class="token string">&quot;07 | Node.js开发环境安装&quot;</span><span class="token punctuation">,</span><span class="token number">136806</span><span class="token punctuation">:</span> <span class="token string">&quot;08 | 第一个Node.js程序：石头剪刀布游戏&quot;</span><span class="token punctuation">,</span><span class="token number">136807</span><span class="token punctuation">:</span> <span class="token string">&quot;09 | 模块：CommonJS规范&quot;</span><span class="token punctuation">,</span>
  <span class="token number">136808</span><span class="token punctuation">:</span> <span class="token string">&quot;10 | 模块：使用模块规范改造石头剪刀布游戏&quot;</span><span class="token punctuation">,</span><span class="token number">136809</span><span class="token punctuation">:</span> <span class="token string">&quot;11 | 模块：npm&quot;</span><span class="token punctuation">,</span><span class="token number">141994</span><span class="token punctuation">:</span> <span class="token string">&quot;12 | 模块：Node.js内置模块&quot;</span><span class="token punctuation">,</span><span class="token number">143517</span><span class="token punctuation">:</span> <span class="token string">&quot;13 | 异步：非阻塞I/O&quot;</span><span class="token punctuation">,</span>
  <span class="token number">143557</span><span class="token punctuation">:</span> <span class="token string">&quot;14 | 异步：异步编程之callback&quot;</span><span class="token punctuation">,</span><span class="token number">143564</span><span class="token punctuation">:</span> <span class="token string">&quot;15 | 异步：事件循环&quot;</span><span class="token punctuation">,</span><span class="token number">143644</span><span class="token punctuation">:</span> <span class="token string">&quot;16 | 异步：异步编程之Promise&quot;</span><span class="token punctuation">,</span><span class="token number">146470</span><span class="token punctuation">:</span> <span class="token string">&quot;17 | 异步：异步编程之async/await&quot;</span><span class="token punctuation">,</span>
  <span class="token number">146569</span><span class="token punctuation">:</span> <span class="token string">&quot;18 | HTTP：什么是HTTP服务器？&quot;</span><span class="token punctuation">,</span><span class="token number">146582</span><span class="token punctuation">:</span> <span class="token string">&quot;19 | HTTP：简单实现一个HTTP服务器&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// client.js</span>
<span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> seq <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">net<span class="token punctuation">.</span>Socket</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host<span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
  port<span class="token punctuation">:</span> <span class="token string">'4000'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> lessonids <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;136797&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136798&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136799&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136800&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136801&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136803&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136804&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136806&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136807&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136808&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;136809&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;141994&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;143517&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;143557&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;143564&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;143644&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;146470&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;146569&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;146582&quot;</span>
<span class="token punctuation">]</span>

<span class="token keyword">let</span> id <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> lessonids<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>

socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 接收到返回数据打印出来</span>
  <span class="token keyword">const</span> seqBuffer <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> titleBuffer <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'接收的内容'</span><span class="token punctuation">,</span>seqBuffer<span class="token punctuation">.</span><span class="token function">readInt16BE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> titleBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
  buffer<span class="token punctuation">.</span><span class="token function">writeInt16BE</span><span class="token punctuation">(</span>seq<span class="token punctuation">)</span>
  buffer<span class="token punctuation">.</span><span class="token function">writeInt32BE</span><span class="token punctuation">(</span>
    lessonids<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span>
  <span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发送的内容'</span><span class="token punctuation">,</span>seq<span class="token punctuation">,</span> lessonids<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
  seq<span class="token operator">++</span>
  <span class="token keyword">return</span> buffer
<span class="token punctuation">}</span>

<span class="token comment">// 模拟全双工通信的随机性</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  id <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> lessonids<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><font color="#1E90FF"><strong>② 黏包解决</strong></font></p> <p>关于黏包的问题我们会在<a href="https://www.taopoppy.cn/node/two_module_net.html" target="_blank" rel="noopener noreferrer">node入门-核心模块net<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中讲解通用状况，下面列出的是上面示例的黏包解决方案：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> oldBuffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 把上一次data事件使用残余的buffer接上来</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>oldBuffer<span class="token punctuation">,</span> buffer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> packageLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// 只要还存在可以解成完整包的包长</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>packageLength <span class="token operator">=</span> <span class="token function">checkComplete</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token keyword">package</span> <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> packageLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>packageLength<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 把这个包解成数据和seq</span>
            <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token keyword">package</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 计算得到要返回的结果，并write返回</span>
            socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>
                <span class="token function">encode</span><span class="token punctuation">(</span><span class="token constant">LESSON_DATA</span><span class="token punctuation">[</span>result<span class="token punctuation">.</span>data<span class="token punctuation">]</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>seq<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 把残余的buffer记下来</span>
        oldBuffer <span class="token operator">=</span> buffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 二进制包编码函数
 * 在一段rpc调用里，服务端需要经常编码rpc调用时，业务数据的返回包
 */</span>
<span class="token keyword">function</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> seq</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 正常情况下，这里应该是使用 protobuf 来encode一段代表业务数据的数据包</span>
    <span class="token comment">// 为了不要混淆重点，这个例子比较简单，就直接把课程标题转buffer返回</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    <span class="token comment">// 一般来说，一个rpc调用的数据包会分为定长的包头和不定长的包体两部分</span>
    <span class="token comment">// 包头的作用就是用来记载包的序号和包的长度，以实现全双工通信</span>
    <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    header<span class="token punctuation">.</span><span class="token function">writeInt16BE</span><span class="token punctuation">(</span>seq<span class="token punctuation">)</span>
    header<span class="token punctuation">.</span><span class="token function">writeInt32BE</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>header<span class="token punctuation">,</span> body<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 二进制包解码函数
 * 在一段rpc调用里，服务端需要经常解码rpc调用时，业务数据的请求包
 */</span>
<span class="token keyword">function</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> header <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> seq <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">readInt16BE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 正常情况下，这里应该是使用 protobuf 来decode一段代表业务数据的数据包</span>
    <span class="token comment">// 为了不要混淆重点，这个例子比较简单，就直接读一个Int32即可</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readInt32BE</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 这里把seq和数据返回出去</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        seq<span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> body
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 检查一段buffer是不是一个完整的数据包。
 * 具体逻辑是：判断header的bodyLength字段，看看这段buffer是不是长于header和body的总长
 * 如果是，则返回这个包长，意味着这个请求包是完整的。
 * 如果不是，则返回0，意味着包还没接收完
 * @param {} buffer 
 */</span>
<span class="token keyword">function</span> <span class="token function">checkComplete</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> bodyLength <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">readInt32BE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">6</span> <span class="token operator">+</span> bodyLength
<span class="token punctuation">}</span>

<span class="token comment">// 假数据</span>
<span class="token keyword">const</span> <span class="token constant">LESSON_DATA</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token number">136797</span><span class="token punctuation">:</span> <span class="token string">&quot;01 | 课程介绍&quot;</span><span class="token punctuation">,</span><span class="token number">136798</span><span class="token punctuation">:</span> <span class="token string">&quot;02 | 内容综述&quot;</span><span class="token punctuation">,</span><span class="token number">136799</span><span class="token punctuation">:</span> <span class="token string">&quot;03 | Node.js是什么？&quot;</span><span class="token punctuation">,</span><span class="token number">136800</span><span class="token punctuation">:</span> <span class="token string">&quot;04 | Node.js可以用来做什么？&quot;</span><span class="token punctuation">,</span><span class="token number">136801</span><span class="token punctuation">:</span> <span class="token string">&quot;05 | 课程实战项目介绍&quot;</span><span class="token punctuation">,</span>
    <span class="token number">136803</span><span class="token punctuation">:</span> <span class="token string">&quot;06 | 什么是技术预研？&quot;</span><span class="token punctuation">,</span><span class="token number">136804</span><span class="token punctuation">:</span> <span class="token string">&quot;07 | Node.js开发环境安装&quot;</span><span class="token punctuation">,</span><span class="token number">136806</span><span class="token punctuation">:</span> <span class="token string">&quot;08 | 第一个Node.js程序：石头剪刀布游戏&quot;</span><span class="token punctuation">,</span><span class="token number">136807</span><span class="token punctuation">:</span> <span class="token string">&quot;09 | 模块：CommonJS规范&quot;</span><span class="token punctuation">,</span>
    <span class="token number">136808</span><span class="token punctuation">:</span> <span class="token string">&quot;10 | 模块：使用模块规范改造石头剪刀布游戏&quot;</span><span class="token punctuation">,</span><span class="token number">136809</span><span class="token punctuation">:</span> <span class="token string">&quot;11 | 模块：npm&quot;</span><span class="token punctuation">,</span><span class="token number">141994</span><span class="token punctuation">:</span> <span class="token string">&quot;12 | 模块：Node.js内置模块&quot;</span><span class="token punctuation">,</span><span class="token number">143517</span><span class="token punctuation">:</span> <span class="token string">&quot;13 | 异步：非阻塞I/O&quot;</span><span class="token punctuation">,</span>
    <span class="token number">143557</span><span class="token punctuation">:</span> <span class="token string">&quot;14 | 异步：异步编程之callback&quot;</span><span class="token punctuation">,</span><span class="token number">143564</span><span class="token punctuation">:</span> <span class="token string">&quot;15 | 异步：事件循环&quot;</span><span class="token punctuation">,</span><span class="token number">143644</span><span class="token punctuation">:</span> <span class="token string">&quot;16 | 异步：异步编程之Promise&quot;</span><span class="token punctuation">,</span><span class="token number">146470</span><span class="token punctuation">:</span> <span class="token string">&quot;17 | 异步：异步编程之async/await&quot;</span><span class="token punctuation">,</span>
    <span class="token number">146569</span><span class="token punctuation">:</span> <span class="token string">&quot;18 | HTTP：什么是HTTP服务器？&quot;</span><span class="token punctuation">,</span><span class="token number">146582</span><span class="token punctuation">:</span> <span class="token string">&quot;19 | HTTP：简单实现一个HTTP服务器&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">net<span class="token punctuation">.</span>Socket</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    host<span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> <span class="token number">4000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> id <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">LESSON_IDS</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> oldBuffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 把上一次data事件使用残余的buffer接上来</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>oldBuffer<span class="token punctuation">,</span> buffer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> completeLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 只要还存在可以解成完整包的包长</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>completeLength <span class="token operator">=</span> <span class="token function">checkComplete</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">package</span> <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> completeLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buffer <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>completeLength<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 把这个包解成数据和seq</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token keyword">package</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">包</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token punctuation">.</span>seq<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，返回值是</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token punctuation">.</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 把残余的buffer记下来</span>
    oldBuffer <span class="token operator">=</span> buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">let</span> seq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 二进制包编码函数
 * 在一段rpc调用里，客户端需要经常编码rpc调用时，业务数据的请求包
 */</span>
<span class="token keyword">function</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 正常情况下，这里应该是使用 protobuf 来encode一段代表业务数据的数据包</span>
    <span class="token comment">// 为了不要混淆重点，这个例子比较简单，就直接把课程id转buffer发送</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    body<span class="token punctuation">.</span><span class="token function">writeInt32BE</span><span class="token punctuation">(</span><span class="token constant">LESSON_IDS</span><span class="token punctuation">[</span>data<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 一般来说，一个rpc调用的数据包会分为定长的包头和不定长的包体两部分</span>
    <span class="token comment">// 包头的作用就是用来记载包的序号和包的长度，以实现全双工通信</span>
    <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    header<span class="token punctuation">.</span><span class="token function">writeInt16BE</span><span class="token punctuation">(</span>seq<span class="token punctuation">)</span>
    header<span class="token punctuation">.</span><span class="token function">writeInt32BE</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 包头和包体拼起来发送</span>
    <span class="token keyword">const</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>header<span class="token punctuation">,</span> body<span class="token punctuation">]</span><span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">包</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>seq<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">传输的课程id为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">LESSON_IDS</span><span class="token punctuation">[</span>data<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seq<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 二进制包解码函数
 * 在一段rpc调用里，客户端需要经常解码rpc调用时，业务数据的返回包
 */</span>
<span class="token keyword">function</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> header <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> seq <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">readInt16BE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> body <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        seq<span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> body<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 检查一段buffer是不是一个完整的数据包。
 * 具体逻辑是：判断header的bodyLength字段，看看这段buffer是不是长于header和body的总长
 * 如果是，则返回这个包长，意味着这个请求包是完整的。
 * 如果不是，则返回0，意味着包还没接收完
 * @param {} buffer 
 */</span>
<span class="token keyword">function</span> <span class="token function">checkComplete</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> bodyLength <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">readInt32BE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">6</span> <span class="token operator">+</span> bodyLength
<span class="token punctuation">}</span>


<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    id <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">LESSON_IDS</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> <span class="token constant">LESSON_IDS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;136797&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136798&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136799&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136800&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136801&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136803&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136804&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136806&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136807&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136808&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;136809&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;141994&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;143517&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;143557&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;143564&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;143644&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;146470&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;146569&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;146582&quot;</span>
<span class="token punctuation">]</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/15/2020, 6:32:10 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/node-BFF/bff_one_yuyan_http.html" class="prev">实战技术预研 - http</a></span> <span class="next"><a href="/node-BFF/bff_two_shizhan_xiazaiye.html">实战页面 - 下载页</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.5b8afd62.js" defer></script><script src="/assets/js/2.26f2bd2e.js" defer></script><script src="/assets/js/80.66a0b271.js" defer></script>
  </body>
</html>
